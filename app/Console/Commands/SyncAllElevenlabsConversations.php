<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Services\ElevenlabsService;
use App\Services\ElevenlabsAIService;
use App\Models\ElevenlabsConversation;
use App\Models\ElevenlabsAgent;
use Illuminate\Support\Facades\Log;
use Carbon\Carbon;

class SyncAllElevenlabsConversations extends Command
{
    protected $signature = 'elevenlabs:sync-all {--from-date=2025-10-20}';
    protected $description = 'Sincroniza TODAS las conversaciones desde una fecha espec√≠fica sin l√≠mites';

    private $elevenlabsService;
    private $aiService;

    public function __construct(ElevenlabsService $elevenlabsService, ElevenlabsAIService $aiService)
    {
        parent::__construct();
        $this->elevenlabsService = $elevenlabsService;
        $this->aiService = $aiService;
    }

    public function handle()
    {
        $fromDate = $this->option('from-date');
        $fromTimestamp = Carbon::parse($fromDate)->startOfDay()->timestamp;
        
        $this->info("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        $this->info("üîÑ SINCRONIZACI√ìN MASIVA DE CONVERSACIONES");
        $this->info("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        $this->info("üìÖ Desde: {$fromDate} (" . Carbon::parse($fromDate)->format('d/m/Y') . ")");
        $this->info("‚è∞ Timestamp: {$fromTimestamp}");
        $this->newLine();

        if (!$this->confirm('¬øDeseas continuar con la sincronizaci√≥n masiva?', true)) {
            $this->info('‚ùå Sincronizaci√≥n cancelada.');
            return 0;
        }

        Log::info('SyncAll: Iniciando sincronizaci√≥n masiva', [
            'from_date' => $fromDate,
            'from_timestamp' => $fromTimestamp
        ]);

        try {
            $this->info('üì• Descargando TODAS las conversaciones con paginaci√≥n...');
            $this->info('‚ÑπÔ∏è  La API usa cursor para paginar (100 conversaciones por p√°gina)');
            $this->newLine();

            $startDate = Carbon::parse($fromDate)->startOfDay();
            $this->line("üìÖ Desde: " . $startDate->format('d/m/Y H:i:s'));
            $this->line("‚è∞ Hasta: Ahora");
            $this->newLine();
            
            $allConversations = [];
            $cursor = null;
            $page = 1;
            $hasMore = true;
            
            $this->line("üì° Descargando p√°ginas...");
            
            // Paginar usando cursor hasta que no haya m√°s
            while ($hasMore) {
                $this->line("   üìÑ P√°gina {$page}...");
                
                $response = $this->elevenlabsService->getConversations($fromTimestamp, $cursor, 100);
                $conversations = $response['conversations'] ?? [];
                $hasMore = $response['has_more'] ?? false;
                $cursor = $response['next_cursor'] ?? null;
                
                $this->line("      ‚úì " . count($conversations) . " conversaciones en esta p√°gina");
                
                if (!empty($conversations)) {
                    $allConversations = array_merge($allConversations, $conversations);
                }
                
                if ($hasMore) {
                    $this->line("      ‚Üí Hay m√°s conversaciones, continuando...");
                } else {
                    $this->line("      ‚úì No hay m√°s p√°ginas");
                }
                
                $page++;
                
                // Peque√±a pausa entre requests para no saturar la API
                if ($hasMore) {
                    usleep(200000); // 0.2 segundos
                }
            }

            $this->newLine();
            $this->info("üìä Total de conversaciones a procesar: " . count($allConversations));
            $this->newLine();

            if (empty($allConversations)) {
                $this->info('‚úÖ No hay conversaciones para sincronizar.');
                return 0;
            }

            $progressBar = $this->output->createProgressBar(count($allConversations));
            $progressBar->setFormat(' %current%/%max% [%bar%] %percent:3s%% - %message%');
            $progressBar->setMessage('Iniciando...');
            $progressBar->start();

            $processedCount = 0;
            $skippedCount = 0;
            $errorCount = 0;
            $noAgentCount = 0;
            $failedCount = 0;
            $emptyTranscriptCount = 0;

            foreach ($allConversations as $conversationData) {
                try {
                    $conversationId = $conversationData['conversation_id'];
                    $agentId = $conversationData['agent_id'];
                    $status = $conversationData['status'] ?? 'unknown';

                    $progressBar->setMessage("Procesando {$conversationId}...");

                    // Omitir conversaciones con status "failed"
                    if ($status === 'failed') {
                        Log::info('SyncAll: Conversaci√≥n con status failed, omitiendo', [
                            'conversation_id' => $conversationId,
                            'status' => $status
                        ]);
                        $failedCount++;
                        $progressBar->advance();
                        continue;
                    }

                    // Verificar si la conversaci√≥n ya existe
                    $existingConversation = ElevenlabsConversation::where('conversation_id', $conversationId)->first();
                    
                    if ($existingConversation) {
                        $skippedCount++;
                        $progressBar->advance();
                        continue;
                    }

                    // Verificar si el agente est√° configurado
                    $agent = ElevenlabsAgent::where('agent_id', $agentId)->first();
                    
                    if (!$agent) {
                        Log::warning('SyncAll: Agente no configurado', [
                            'agent_id' => $agentId,
                            'conversation_id' => $conversationId
                        ]);
                        $noAgentCount++;
                        $progressBar->advance();
                        continue;
                    }

                    // Obtener detalles completos de la conversaci√≥n
                    $fullConversation = $this->elevenlabsService->getConversation($conversationId);
                    
                    // Crear la conversaci√≥n
                    $conversation = $this->createConversationFromData($fullConversation);
                    
                    if ($conversation) {
                        // Procesar con IA
                        $this->processConversationWithAI($conversation, $agent);
                        $processedCount++;
                    } else {
                        // Si createConversationFromData devuelve null, es porque el transcript est√° vac√≠o
                        $emptyTranscriptCount++;
                    }

                    $progressBar->advance();

                    // Peque√±a pausa para no saturar la API
                    usleep(100000); // 0.1 segundos

                } catch (\Exception $e) {
                    Log::error('SyncAll: Error procesando conversaci√≥n', [
                        'conversation_id' => $conversationData['conversation_id'] ?? 'unknown',
                        'error' => $e->getMessage()
                    ]);
                    $errorCount++;
                    $progressBar->advance();
                }
            }

            $progressBar->setMessage('Completado');
            $progressBar->finish();
            $this->newLine(2);

            $this->info("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
            $this->info("üìä RESUMEN DE SINCRONIZACI√ìN MASIVA:");
            $this->info("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
            $this->info("   üì• Total encontradas: " . count($allConversations));
            $this->info("   ‚úÖ Procesadas: {$processedCount}");
            $this->info("   ‚è© Omitidas (duplicadas): {$skippedCount}");
            $this->info("   ‚ùå Status 'failed': {$failedCount}");
            $this->info("   üìù Transcript vac√≠o: {$emptyTranscriptCount}");
            $this->info("   ‚ö†Ô∏è  Sin agente configurado: {$noAgentCount}");
            $this->info("   ‚ùó Errores: {$errorCount}");
            $this->info("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
            
            Log::info('SyncAll: Sincronizaci√≥n masiva completada', [
                'total' => count($allConversations),
                'processed' => $processedCount,
                'skipped' => $skippedCount,
                'failed_status' => $failedCount,
                'empty_transcript' => $emptyTranscriptCount,
                'no_agent' => $noAgentCount,
                'errors' => $errorCount
            ]);

            return 0;

        } catch (\Exception $e) {
            $this->error('‚ùå Error en sincronizaci√≥n masiva: ' . $e->getMessage());
            Log::error('SyncAll: Error fatal', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            return 1;
        }
    }

    /**
     * Crear conversaci√≥n desde datos de Eleven Labs
     */
    private function createConversationFromData(array $data): ?ElevenlabsConversation
    {
        try {
            // Formatear transcripci√≥n
            $transcript = '';
            if (isset($data['transcript']) && is_array($data['transcript'])) {
                foreach ($data['transcript'] as $message) {
                    $role = $message['role'] === 'agent' ? 'Agente' : 'Cliente';
                    $messageText = trim($message['message'] ?? '');
                    if (!empty($messageText)) {
                        $transcript .= "[{$role}] {$messageText}\n";
                    }
                }
            }

            // Validar que el transcript no est√© vac√≠o
            $transcript = trim($transcript);
            if (empty($transcript)) {
                Log::warning('SyncAll: Transcript vac√≠o, omitiendo conversaci√≥n', [
                    'conversation_id' => $data['conversation_id'] ?? 'unknown',
                ]);
                return null;
            }

            // Buscar cliente por tel√©fono si existe
            $clientId = null;
            if (isset($data['phone_call']['external_number'])) {
                $phoneNumber = $data['phone_call']['external_number'];
                $client = \App\Models\Clients\Client::where('phone', 'LIKE', "%{$phoneNumber}%")->first();
                if ($client) {
                    $clientId = $client->id;
                }
            }

            $conversation = ElevenlabsConversation::create([
                'conversation_id' => $data['conversation_id'],
                'agent_id' => $data['agent_id'],
                'agent_name' => $data['agent_name'] ?? null, // Guardar nombre del agente
                'client_id' => $clientId,
                'conversation_date' => isset($data['metadata']['start_time_unix_secs']) 
                    ? Carbon::createFromTimestamp($data['metadata']['start_time_unix_secs'])
                    : now(),
                'duration_seconds' => $data['metadata']['call_duration_secs'] ?? 0,
                'transcript' => $transcript,
                'metadata' => $data['metadata'] ?? [],
                'sentiment_category' => null,
                'specific_category' => null,
                'summary_es' => null,
                'confidence_score' => null,
                'processing_status' => 'pending',
                'processed_at' => null,
            ]);

            return $conversation;

        } catch (\Exception $e) {
            Log::error('SyncAll: Error creando conversaci√≥n', [
                'conversation_id' => $data['conversation_id'] ?? 'unknown',
                'error' => $e->getMessage()
            ]);
            return null;
        }
    }

    /**
     * Procesar conversaci√≥n con IA
     */
    private function processConversationWithAI(ElevenlabsConversation $conversation, ElevenlabsAgent $agent)
    {
        try {
            // El m√©todo processConversation ya guarda todo directamente en el modelo
            $this->aiService->processConversation($conversation);

        } catch (\Exception $e) {
            Log::error('SyncAll: Excepci√≥n en procesamiento IA', [
                'conversation_id' => $conversation->conversation_id,
                'error' => $e->getMessage()
            ]);
        }
    }
}

